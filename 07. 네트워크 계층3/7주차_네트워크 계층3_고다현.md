# 5. Network Layer: The Control Plane

### 자율 시스템(autonomous system, AS)

### Interconnected Ases

- forwarding table은 `intra-AS, inter-AS` 라우팅 알고리즘으로 구성되어 있음
    - `intra-As` : AS 내부의 도착지 결정
        - Routing : IGP(interior gateway protocols), RIP, OSPF, IGRP
    - `inter-AS, intra-AS` : AS 바깥으로 나가는 도착지도 결

### OSPF (Open Shortest Path First)

- 링크 상태 정보를 플러딩(flooding = 브로드캐스팅)하고 다익스트라 최소 비용 경로 알고리즘을 사용하는 `link state algorithm`
- 각 라우터는 전체 AS에 대한 완벽한 토폴로지 그래프를 얻는다
- 라우터는 **자율 시스템 내의 다른 모든 라우터에게** 라우팅 정보를 브로드캐스팅한다.
    - 링크 상태가 변경될 때마다
    - 링크 상태가 변경되지 않았더라도 정기적(최소 30분)으로 수행
- `IS-IS(Intermediate System to Intermediate System) routing` 와 유사
- 특징
    - 보안 : 모든 메세지는authenticated 되어 있음
    - 같은 비용을 가지는 여러 경로가 가능함
    (RIP는 경로 1개만 가능)
    - **모든 트래픽을 전달하기 위한 단 하나의 경로를 선택할 필요가 없다
    ⇒** 각각의 링크에 서로 다른 TOS에 따라서 비용 지수가 다름
    (Ex) 위성 링크 비용은 낮고, real-time ToS는 높은 비용)
    - uni- 와 multi-cast 통합 지원 : `MOSPF(multicast OSPF)`
    - large domain에서는 계층적인 OSPF사용
        
        ![image](https://github.com/SSAFY-CSStudy/Network/assets/101400650/3d2f8486-f4fd-4e07-aac2-a0fa619c008b)

        

### Hierarchical OSPF

OSPF의 자율 시스템(AS)는 계층적인 영역(area)으로 구성될 수 있다.

- 각 영역은 자신의 OSPF 링크 상태 라우팅 알고리즘을 수행한다.
- 한 역역 내의 라우터는 **같은 영역 내의 라우터들에게만** 링크 상태를 브로드캐스트한다.
- 각 영역 내에서 하나 혹은 그 이상의 `영역 경계 라우터(area border router)`가 **영역 외부로의 패킷 라우팅을 책임진다.**
- `백본 영역`의 주요 역할은 AS 내 영역 간의 트래픽을 라우팅하는 것이다.

### BGP(Border GateWay Protoco) : Internet inter-AS routing

- eBGP : 이웃한 AS 들로 부터 reachability information 획득
- iBGP : AS 안에서 internal 라우터들한테 reachability information 를 전달
- 좋은 라우터의 결정 조건 : reachability information 과 policy로 판단
- 서브넷이 인터넷의 다른 라우터들에게 존재를 알리는 것으로 사용됨
    
    ![image](https://github.com/SSAFY-CSStudy/Network/assets/101400650/cb7f0808-06f0-45a8-aa8c-638a3db81dd7)

    
- 경로 결정
    - advertisee perfix는 BGP 속성들을 포함
        - perfix + attribute = route
    - 속성
        
        **AS-PATH**
        
        - **알림 메시지가 통과하는 AS들의 리스트**를 담는다.
            1. 프리픽스가 어떤 AS에 전달되었을 때
            2. 그 AS는 자신의 ASN을 `AS-PATH` 내 현재 리스트에 추가한다.
        - 메시지의 루프를 감지하고 방지하기 위해 활용한다.
            1. 어떤 라우터가 자신의 AS가 경로 리스트에 포함되어 있는 것을 발견하면
            2. 그 알림 메시지를 버린다.
        
        **NEXT-HOP**
        
        - **AS-PATH가 시작되는 라우터 인터페이스의 IP 주소**
        
        ![image](https://github.com/SSAFY-CSStudy/Network/assets/101400650/e8d23a94-ede3-4945-9857-fe2d04129253)

        

### Hot Potato Routing

: 가능한 모든 경로 중, 경로 각각의 시작점인 NEXT-HOP 라우터까지의 경로 비용이 최소가 되는 경로를 선택

1. 여러 게이트웨이를 통해 서브넷 x에 도달할 수 있다는 사실을 AS 간 프로토콜로부터 알게 된다.
2. 각 게이트웨이까지의 최소 비용 경로를 정하기 위해 AS 내부 프로토콜을 통해 얻은 라우팅 정보를 이용한다.
3. **뜨거운 감자 라우팅: 가장 적은 비용의 게이트웨이를 선택한다.**
4. 포워딩 테이블로부터 최소 비용 게이트웨이로의 인터페이스 I를 결정한 후 포워딩 테이블에 `(x, I)`를 추가한다.

![image](https://github.com/SSAFY-CSStudy/Network/assets/101400650/a4ee49e2-528d-4baf-9f60-a546e5179336)

### AS 간 라우팅 과 AS 내부 라우팅 프로토콜의 차이

- **정책**
    - inter-AS : 특정 AS에서 시작된 트래픽이 다른 특정 AS를 통과할 수 없다는 것은 중요할 수 있으며, 특정 AS가 다른 AS들 사이에서 어떤 트래픽을 전달할지 결장할 수 있기를 원하는 것 역시 당연하다.
    - intra-AS : 모든 것이 동일한 관리 통제
- **확장성 :** 수정되는 트래픽을 줄이기 위해 계층적 라우팅 테이블 사이즈를 저장해 놓음
- **성능**
    - intra-AS : 성능에 집증할 수 있음
    - inter-AS : 성능 위에 정책이 지배
    

## SDN (Software defined networking)

### 플로우 기반 포워딩

`SDN`으로 제어되는 스위치들에서의 패킷 전달은 트랜스포트 계층, 네트워크 계층, 또는 링크 계층 헤더의 **어떤 값을 기반으로 하든 이루어질 수 있다.**

### 데이터 평면과 제어 평면의 분리

- 데이터 평면
    - 네트워크의 `스위치`들로 구성된다. (이들은 상대적으로 단순하지만 빠른 장치들)
    - 자신들의 플로우 테이블 내용을 기반으로 ‘매치 플러스 액션’을 수행한다.
- 제어 평면 : 서버와 스위치들의 플로우 테이블을 결정, 관리하는 `소프트웨어`로 이루어진다.

### 네트워크 제어 기능이 데이터 평면 스위치 외부에 존재

1. `SDN 컨트롤러`(또는 네트워크 운영체제)
2. `SDN 네트워크 제어 애플리케이션`들의 집합

![image](https://github.com/SSAFY-CSStudy/Network/assets/101400650/a4245dd3-7e17-483b-a99e-d4aba18a7c16)


### SDN 제어 평면

- SDN 컨트롤러
    1. `네트워크 제어 애플리케이션 계층과의 인터페이스`
    2. `네트워크 전역 상태 관리 계층`
    3. `통신 계층`
    
    ![image](https://github.com/SSAFY-CSStudy/Network/assets/101400650/9f8a63a0-bdca-4021-932b-ff77188ac2ff)

    
- 통신 계층 : **SDN 컨트롤러와 제어받는 네트워크 장치들 사이의 통신**
    - SDN 컨트롤러가 원격의 SDN 기능이 가능한 장치들의 동작을 제어하려면 컨트롤러와 그 장치들 사이에 정보를 전달하는 프로토콜이 필요하다.
    - 장치는 주변에서 관찰한 이벤트를 컨트롤러에 알려, 네트워크 상태에 대한 최신의 정보를 제공해야 한다.
    

### OpenFlow 프로토콜

## ICMP( internet control message protocol)

 호스트와 라우터가 서로 간에 네트워크 계층 정보를 주고받기 위해 사용된다.

![image](https://github.com/SSAFY-CSStudy/Network/assets/101400650/61d483d9-dc2b-477a-bb07-18ea6d60fc6c)


### **Traceroute 프로그램**

아래의 방식으로 출발지 호스트는 자신과 목적지 호스트 사이에 있는 라우터들의 수와 정체, 그리고 두 호스트 간의 왕복 시간을 알게 된다.

1. **출발지와 목적지 사이의 라우터 이름과 주소를 알아내기 위해**
    
    출발지의 Traceroute는 일련의 `IP 데이터그램`을 목적지에 보낸다.
    
    - 각각의 데이터그램은 UDP 포트 번호를 가진 **UDP 세그먼트**를 운반한다.
    - TTL 값은 첫 번째 데이터그램이 1, 두 번째는 2, 세 번째는 3, 이런 식이다.
2. 출발지는 각 데이터그램에 대해 타이머를 작동시킨다.
    - n번째 데이터그램이 n번째 라우터에 도착하면 해당 라우터는 데이터그램의 TTL이 방금 만료되었음을 알게 된다.
3. IP 프로토콜 규칙에 따라 라우터는 데이터그램을 폐기하고 `ICMP 경고 메시지(타입 11, 코드 0)`를 출발지에 보낸다.
    - 이 경고 메시지는 라우터의 이름과 IP 주소를 포함한다.
4. 이 ICMP 메시지가 출발지에 도착하면, 출발지는
    
    (1) 타이머로부터 왕복 시간(round-trip time, RTT),
    
    (2) ICMP 메시지로부터 n번째 라우터의 주소와 이름을 획득한다.
    
